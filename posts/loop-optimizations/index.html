<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Loop Optimizations in compilers[Part 1] | Interpreting compilers</title><meta name=keywords content><meta name=description content="Introduction Loops are &ldquo;the&rdquo; most compute intensive part of any software program making loop optimizations some of the most rewarding optimizations for a compiler. In this post, I&rsquo;ll try to go over some of these optimizations which are covered by LLVM(I&rsquo;m sure you&rsquo;ll find them in other compilers too). This is not an extensive list you can always find more.
Loop Invariant Code Motion (Code hoisting) It&rsquo;s a known coding practice to always keep definitions and constant code outside the loop."><meta name=author content><link rel=canonical href=https://singh-yashwant.github.io/posts/loop-optimizations/><link crossorigin=anonymous href=/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe+FVUFzPh7U=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://singh-yashwant.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://singh-yashwant.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://singh-yashwant.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://singh-yashwant.github.io/apple-touch-icon.png><link rel=mask-icon href=https://singh-yashwant.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Loop Optimizations in compilers[Part 1]"><meta property="og:description" content="Introduction Loops are &ldquo;the&rdquo; most compute intensive part of any software program making loop optimizations some of the most rewarding optimizations for a compiler. In this post, I&rsquo;ll try to go over some of these optimizations which are covered by LLVM(I&rsquo;m sure you&rsquo;ll find them in other compilers too). This is not an extensive list you can always find more.
Loop Invariant Code Motion (Code hoisting) It&rsquo;s a known coding practice to always keep definitions and constant code outside the loop."><meta property="og:type" content="article"><meta property="og:url" content="https://singh-yashwant.github.io/posts/loop-optimizations/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-04-02T01:20:52+05:30"><meta property="article:modified_time" content="2023-04-02T01:20:52+05:30"><meta property="og:site_name" content="Interpreting compilers"><meta name=twitter:card content="summary"><meta name=twitter:title content="Loop Optimizations in compilers[Part 1]"><meta name=twitter:description content="Introduction Loops are &ldquo;the&rdquo; most compute intensive part of any software program making loop optimizations some of the most rewarding optimizations for a compiler. In this post, I&rsquo;ll try to go over some of these optimizations which are covered by LLVM(I&rsquo;m sure you&rsquo;ll find them in other compilers too). This is not an extensive list you can always find more.
Loop Invariant Code Motion (Code hoisting) It&rsquo;s a known coding practice to always keep definitions and constant code outside the loop."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://singh-yashwant.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Loop Optimizations in compilers[Part 1]","item":"https://singh-yashwant.github.io/posts/loop-optimizations/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Loop Optimizations in compilers[Part 1]","name":"Loop Optimizations in compilers[Part 1]","description":"Introduction Loops are \u0026ldquo;the\u0026rdquo; most compute intensive part of any software program making loop optimizations some of the most rewarding optimizations for a compiler. In this post, I\u0026rsquo;ll try to go over some of these optimizations which are covered by LLVM(I\u0026rsquo;m sure you\u0026rsquo;ll find them in other compilers too). This is not an extensive list you can always find more.\nLoop Invariant Code Motion (Code hoisting) It\u0026rsquo;s a known coding practice to always keep definitions and constant code outside the loop.","keywords":[],"articleBody":"Introduction Loops are “the” most compute intensive part of any software program making loop optimizations some of the most rewarding optimizations for a compiler. In this post, I’ll try to go over some of these optimizations which are covered by LLVM(I’m sure you’ll find them in other compilers too). This is not an extensive list you can always find more.\nLoop Invariant Code Motion (Code hoisting) It’s a known coding practice to always keep definitions and constant code outside the loop. What’s interesting is even if you don’t, the compiler will take care of it. The compiler determines if any instruction is “invariant” and moves it out of the loop. Either inside prehearder(every loop in LLVM has a preheader which has only 1 outgoing edge to the loop header) or loop exit (similarly every loop has an exit block with only 1 incoming edge).\nLet us look at an example.\nBefore licm After licm Ignoring we aren’t doing anything inside the loop notice how the compiler recognizes that loading and storing %AVal and %BVal has nothing to do inside and hoists them to preheader. This also causes few ‘phi’ instructions to appear in the exit block, what those are is a story for another day.\nLoop deletion No points for guessing, this optimization deletes any loop which doesn’t have effects on the code, so rest assured all those random loops you write aren’t gonna affect your code’s performance.\nIn the below example ‘for.loop’ represents a loop block, although it’s not much of a loop since the exit condition is a constant(‘false’) nonetheless the compiler sees it as a loop and would have behaved similarly for a proper loop if it does not affect rest of the code. This loop gets deleted once we explicitly ask the compiler to perform loop deletion.\nBefore loop deletion\nAfter loop deletion Loop unswitching This optimization transforms loops containing branches on loop invariant(independent) conditions to multiple loops by moving the branch outside and a copy of a loop in both branches. This might sound like suboptimizing but it isn’t.\nfor (...): A if (loop invariant cond): B else: C turns into,\nif (loop invariant cond): for (...): A, B else: for (...): A, C The gain here is only checking the condition once instead of in every iteration.\nLet us take a look at the compiler in action.\nBefore loop unswitch ‘continue’ block is the invariant condition guarded code inside the loop.\nAfter loop unswitch The conditional instruction is moved to the entry block and the loop now is guarded by it not the other way around.\nThis is it for this post. I intend to cover more of these optimizations in the future. Thanks for reading!\nSubscribe * indicates required Email Address * ","wordCount":"459","inLanguage":"en","datePublished":"2023-04-02T01:20:52+05:30","dateModified":"2023-04-02T01:20:52+05:30","mainEntityOfPage":{"@type":"WebPage","@id":"https://singh-yashwant.github.io/posts/loop-optimizations/"},"publisher":{"@type":"Organization","name":"Interpreting compilers","logo":{"@type":"ImageObject","url":"https://singh-yashwant.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://singh-yashwant.github.io/ accesskey=h title="Interpreting compilers (Alt + H)">Interpreting compilers</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://singh-yashwant.github.io/about/about title=About><span>About</span></a></li><li><a href=https://singh-yashwant.github.io/posts title=Blog><span>Blog</span></a></li><li><a href=https://singh-yashwant.github.io/ title=Home><span>Home</span></a></li><li><a href=https://reviews.llvm.org/p/yassingh/ title=LLVM><span>LLVM</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href="https://drive.google.com/file/d/1_-RtyeEgRoOOvMLABvObnJws56uOrnvG/view?usp=sharing" title=Resume><span>Resume</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Loop Optimizations in compilers[Part 1]</h1><div class=post-meta><span title='2023-04-02 01:20:52 +0530 +0530'>April 2, 2023</span>&nbsp;·&nbsp;3 min</div></header><div class=post-content><h2 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h2><p>Loops are &ldquo;the&rdquo; most compute intensive part of any software program making loop optimizations some of the most rewarding optimizations for a compiler. In this post, I&rsquo;ll try to go over some of these optimizations which are covered by LLVM(I&rsquo;m sure you&rsquo;ll find them in other compilers too). This is not an extensive list you can always find more.</p><h3 id=loop-invariant-code-motion-code-hoisting>Loop Invariant Code Motion (Code hoisting)<a hidden class=anchor aria-hidden=true href=#loop-invariant-code-motion-code-hoisting>#</a></h3><p>It&rsquo;s a known coding practice to always keep definitions and constant code outside the loop. What&rsquo;s interesting is even if you don&rsquo;t, the compiler will take care of it. The compiler determines if any instruction is &ldquo;invariant&rdquo; and moves it out of the loop. Either inside prehearder(every loop in LLVM has a preheader which has only 1 outgoing edge to the loop header) or loop exit (similarly every loop has an exit block with only 1 incoming edge).</p><p>Let us look at an <a href=https://godbolt.org/z/8W9qoYs68>example</a>.</p><p><em>Before licm</em>
<img loading=lazy src=/images/licm1.jpg alt=img1></p><p><em>After licm</em>
<img loading=lazy src=/images/licm2.jpg alt=img1></p><p>Ignoring we aren&rsquo;t doing anything inside the loop notice how the compiler recognizes that loading and storing %AVal and %BVal has nothing to do inside and hoists them to preheader. This also causes few &lsquo;phi&rsquo; instructions to appear in the exit block, what those are is a story for another day.</p><h3 id=loop-deletion>Loop deletion<a hidden class=anchor aria-hidden=true href=#loop-deletion>#</a></h3><p>No points for guessing, this optimization deletes any loop which doesn&rsquo;t have effects on the code, so rest assured all those random loops you write aren&rsquo;t gonna affect your code&rsquo;s performance.</p><p>In the below <a href=https://godbolt.org/z/zfdPYxd4s>example</a>
&lsquo;for.loop&rsquo; represents a loop block, although it&rsquo;s not much of a loop since the exit condition is a constant(&lsquo;false&rsquo;) nonetheless the compiler sees it as a loop and would have behaved similarly for a proper loop if it does not affect rest of the code. This loop gets deleted once we explicitly ask the compiler to perform loop deletion.</p><p><em>Before loop deletion</em></p><p><img loading=lazy src=/images/ld1.jpg alt=img1></p><p><em>After loop deletion</em>
<img loading=lazy src=/images/ld2.jpg alt=img1></p><h3 id=loop-unswitching>Loop unswitching<a hidden class=anchor aria-hidden=true href=#loop-unswitching>#</a></h3><p>This optimization transforms loops containing branches on loop invariant(independent) conditions to multiple loops by moving the branch outside and a copy of a
loop in both branches. This might sound like suboptimizing but it isn&rsquo;t.</p><pre tabindex=0><code>for (...):
    A
    if (loop invariant cond):
        B
    else:
        C
</code></pre><p>turns into,</p><pre tabindex=0><code>if (loop invariant cond):
    for (...):
        A, B
else:
    for (...):
        A, C
</code></pre><p>The gain here is only checking the condition once instead of in every iteration.</p><p>Let us take a look at the compiler in <a href="-passes='loop(simple-loop-unswitch),verify%3Cloops%3E'">action</a>.</p><p><em>Before loop unswitch</em>
<img loading=lazy src=/images/lu1.jpg alt=img1></p><p>&lsquo;continue&rsquo; block is the invariant condition guarded code inside the loop.</p><p><em>After loop unswitch</em>
<img loading=lazy src=/images/lu2.jpg alt=img1></p><p>The conditional instruction is moved to the entry block and the loop now is guarded by it not the other way around.</p><hr><p>This is it for this post. I intend to cover more of these optimizations in the future. Thanks for reading!</p><hr><link href=//cdn-images.mailchimp.com/embedcode/classic-071822.css rel=stylesheet type=text/css><style type=text/css>#mc_embed_signup{background:#fff;clear:left;font:14px Helvetica,Arial,sans-serif;width:600px}</style><div id=mc_embed_signup><form action="https://yashwantsingh.us13.list-manage.com/subscribe/post?u=962526bdb438a39d5262ef34b&amp;id=d7fe01525e&amp;f_id=005296e2f0" method=post id=mc-embedded-subscribe-form name=mc-embedded-subscribe-form class=validate target=_blank novalidate><div id=mc_embed_signup_scroll><h2>Subscribe</h2><div class=indicates-required><span class=asterisk>*</span> indicates required</div><div class=mc-field-group><label for=mce-EMAIL>Email Address <span class=asterisk>*</span></label>
<input type=email name=EMAIL class="required email" id=mce-EMAIL required>
<span id=mce-EMAIL-HELPERTEXT class=helper_text></span></div><div id=mce-responses class="clear foot"><div class=response id=mce-error-response style=display:none></div><div class=response id=mce-success-response style=display:none></div></div><div style=position:absolute;left:-5000px aria-hidden=true><input type=text name=b_962526bdb438a39d5262ef34b_d7fe01525e tabindex=-1></div><div class=optionalParent><div class="clear foot"><input type=submit value=Subscribe name=subscribe id=mc-embedded-subscribe class=button><p class=brandingLogo><a href=http://eepurl.com/irce2- title="Mailchimp - email marketing made easy and fun"><img src=https://eep.io/mc-cdn-images/template_images/branding_logo_text_dark_dtp.svg></a></p></div></div></div></form></div><script type=text/javascript src=//s3.amazonaws.com/downloads.mailchimp.com/js/mc-validate.js></script><script type=text/javascript>(function(){window.fnames=new Array,window.ftypes=new Array,fnames[0]="EMAIL",ftypes[0]="email",fnames[1]="FNAME",ftypes[1]="text",fnames[2]="LNAME",ftypes[2]="text",fnames[3]="ADDRESS",ftypes[3]="address",fnames[4]="PHONE",ftypes[4]="phone",fnames[5]="BIRTHDAY",ftypes[5]="birthday"})(jQuery);var $mcj=jQuery.noConflict(!0)</script></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://singh-yashwant.github.io/>Interpreting compilers</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>